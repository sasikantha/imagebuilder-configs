name: WebServerSetupComponent
description: Install and configure Apache web server with custom content
schemaVersion: 1.0

phases:
  - name: build
    steps:
      - name: UpdateSystem
        action: ExecuteBash
        inputs:
          commands:
            - yum update -y
            
      - name: InstallApache
        action: ExecuteBash
        inputs:
          commands:
            - yum install -y httpd
            - systemctl enable httpd
            
      - name: CreateWebContent
        action: ExecuteBash
        inputs:
          commands:
            - 'echo "<h1>This is built using Golden AMI v2.0.0</h1>" > /var/www/html/index.html'
            - 'TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")'
            - 'INSTANCE_ID=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/instance-id)'
            - 'echo "<p>Instance ID: $INSTANCE_ID</p>" >> /var/www/html/index.html'
            - 'echo "<p>AMI ID: $(curl -s http://169.254.169.254/latest/meta-data/ami-id)</p>" >> /var/www/html/index.html'
            - 'echo "<p>Built on: $(date)</p>" >> /var/www/html/index.html'
            
  - name: test
    steps:
      - name: TestApacheInstallation
        action: ExecuteBash
        inputs:
          commands:
            - systemctl status httpd
            - test -f /var/www/html/index.html
            
      - name: TestWebContent
        action: ExecuteBash
        inputs:
          commands:
            - grep "Golden AMI" /var/www/html/index.html